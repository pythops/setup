- name: Install pip
  shell: python -Im ensurepip --upgrade --user

- name: Create $HOME/.python directory
  file:
    path: $HOME/.python
    state: directory

- name: Install pip-tools package
  pip:
    name: pip-tools
    state: present
    extra_args: --user
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"

- name: Copy packages.in
  copy:
    src: python/packages.in
    dest: $HOME/.python/packages.in

- name: Generate python packages
  shell: pip-compile --upgrade $HOME/.python/packages.in --output-file $HOME/.python/packages.txt --resolver=backtracking
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"

- name: Install python packages
  pip:
    requirements: $HOME/.python/packages.txt
    state: present
    extra_args: --user
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"

#
# Poetry
#
- name: Install Poetry
  shell: curl -sSL https://install.python-poetry.org | python3 -

- name: Create poetry config dir
  file:
    path: $HOME/.config/pypoetry
    state: directory

- name: Copy poetry config file
  copy:
    src: config/pypoetry/config.toml
    dest: $HOME/.config/pypoetry/config.toml

- name: Create omz  completion file
  file:
    path: $HOME/.oh-my-zsh/custom/plugins/poetry/
    state: directory

- name: Generate completion file
  shell: poetry completions zsh > $HOME/.oh-my-zsh/custom/plugins/poetry/_poetry
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"

#
# pdbpp
#
- name: Copy pdbpp config
  copy:
    src: python/pdbrc.py
    dest: $HOME/.pdbrc.py

#
# ruff
#

- name: Create ruff config dir
  file:
    path: $HOME/.config/ruff
    state: directory

- name: Copy ruff config
  copy:
    src: config/ruff/pyproject.toml
    dest: $HOME/.config/ruff/pyproject.toml
